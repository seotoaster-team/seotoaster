$(function(){var c=$("#template-content").hide().detach();c.insertBefore("#editor");window.editor=ace.edit("edittemplate");editor.setTheme("ace/theme/crimson_editor");var b=require("ace/mode/html").Mode;editor.getSession().setMode(new b);editor.getSession().setValue(c.val());editor.getSession().setUseWrapMode(!0);editor.setShowPrintMargin(!1);$("#title").focus();$("#frm_template").on("submit",saveTemplate);showListPages();showTemplateList();$("#templatelist").on("click",".template_name",function(){showSpinner();
$(".template_item").removeClass("curr-template").find(".template-check").remove();$(this).before('<span class="template-check ticon-check icon16"/></span>').parent().addClass("curr-template");$.post($("#website_url").val()+"backend/backend_theme/gettemplate/",{listtemplates:$(this).parent().find('input[name="template-id"]').val()},function(a){!1!=a.error&&($("#frm_template").find("#title").val(a.responseText.name),editor.getSession().setValue(a.responseText.content),$("#frm_template").find("#template_id").val(a.responseText.name),
$("#frm_template").find("#template-type").val(a.responseText.type),$.getJSON($("#website_url").val()+"backend/backend_theme/pagesviatemplate/",{template:a.responseText.name},function(a){$("#pcount").text(a.pagesUsingTemplate)}),showTemplateList(),showListPages(),hideSpinner())},"json");$("#templatelist").hide("slide",{direction:"right"})}).on("click",".template_delete",function(){deleteTemplate($(this).closest(".template_item"));return!1});$(document).on("click","#listpages-btn",function(a){a.preventDefault();
$("#listpages").show("slide",{direction:"right"})});$(document).on("click","#listtemplates-btn",function(a){a.preventDefault();a=$("#templatelist");a.show("slide",{direction:"right"});a.find(".template_group").css("max-height","none").css({"max-height":a.find(".content").height()-a.find(".template_header:last").outerHeight(!0)*a.find(".template_header").length})});$("textarea").on("keydown",function(a){a.ctrlKey&&83==a.keyCode&&(a.preventDefault(),saveTemplate())})});
function showTemplateList(c){var b=$("#templatelist");b.find(".content").length&&"update"!=c||$.post($("#website_url").val()+"backend/backend_theme/gettemplate/",{listtemplates:"all",pageId:$("#pageId").val(),beforeSend:showSpinner("#templatelist")},function(a){b.html(a).find(".content").accordion({heightStyle:"content",header:".template_header",collapsible:!0,icons:{header:"ticon-arrow-right",activeHeader:"ticon-arrow-down"},create:function(a,c){b.find(".template_group").css({"max-height":b.find(".content").height()-
b.find(".template_header:last").outerHeight(!0)*b.find(".template_header").length})}});a=$("#template_id").val();$(".template_item").removeClass("curr-template").find(".template-check").remove();$(".template_item").has('input[value="'+a+'"]').addClass("curr-template").find(".template_name").before('<span class="template-check ticon-check icon16"/></span>');hideSpinner()},"html")}
function showListPages(c){$.post($("#website_url").val()+"backend/backend_page/listpages/",{template:$("#template_id").val(),format:"html"},function(b){$("#listpages").html(b)},"html")}
function saveTemplate(){var c=editor.getSession().getValue();$.ajax({url:$(this).attr("action"),type:"post",dataType:"json",data:{content:c,pageId:$("#pageId").val(),templateType:$("#template-type").val(),name:$("#title").val(),id:$("#template_id").val()},beforeSend:function(){showSpinner()},success:function(b){hideSpinner();b.error?"string"===typeof b.responseText?showMessage(b.responseText,!0):showMessage(b.responseText.join(". "),!0):(showMessage("Template saved"),"new"==b.responseText?($("#title").val(""),
editor.getSession().setValue("")):"update"==b.responseText&&showTemplateList(b.responseText))},error:function(b,a){showMessage(a,!0)}});return!1}
function deleteTemplate(c){showConfirm("You are about to remove template. Are you sure?",function(){$.ajax({url:$("#website_url").val()+"backend/backend_theme/deletetemplate/",type:"post",beforeSend:function(){showSpinner()},data:{id:c.find('input[name="template-id"]').val()},success:function(b){hideSpinner();b.error||c.remove();showMessage(b.responseText,b.error)},dataType:"json"})})};
