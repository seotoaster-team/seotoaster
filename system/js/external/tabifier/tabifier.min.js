var level=0,LOOP_SIZE=100;function runTabifier(a,d){showSpinner();"HTML"==d&&cleanHTML(a);"CSS"==d&&cleanCSS(a);"cstyle"==d&&cleanCStyle(a)}function finishTabifier(a){a=a.replace(/\n\s*\n/g,"\n");a=a.replace(/^[\s\n]*/,"");a=a.replace(/[\s\n]*$/,"");editor.getSession().setValue(a);hideSpinner();level=0}
function cleanHTML(a){function d(){for(var l=c;c<a.length&&c<l+LOOP_SIZE;c++){b=c;if(-1==a.substr(c).indexOf("<")){e+=a.substr(c);finishTabifier(e);return}for(;"<"!=a.charAt(b);)b++;c!=b&&(h=a.substr(c,b-c),h.match(/^\s+$/)||("\n"==e.charAt(e.length-1)?e+=tabs():"\n"==h.charAt(0)&&(e+="\n"+tabs(),h=h.replace(/^\s+/,"")),h=h.replace(/\s+/g," "),e+=h),h.match(/\n/)&&(e+="\n"+tabs()));for(k=b;">"!=a.charAt(b);)b++;g=a.substr(k,b-k);c=b;if("!--"==g.substr(1,3)){if(!g.match(/--$/)){for(;"--\x3e"!=a.substr(b,
3);)b++;b+=2;g=a.substr(k,b-k);c=b}"\n"!=e.charAt(e.length-1)&&(e+="\n");e+=tabs();e+=g+">\n"}else if("!"==g[1])e=placeTag(g+">",e);else if("?"==g[1])e+=g+">\n";else if(t=g.match(/^<(script|style)/i)){if(t[1]=t[1].toLowerCase(),g=cleanTag(g),e=placeTag(g,e),f=String(a.substr(c+1)).toLowerCase().indexOf("</"+t[1]))h=a.substr(c+1,f),c+=f,e+=h}else g=cleanTag(g),e=placeTag(g,e)}c<a.length?setTimeout(d,0):finishTabifier(e)}var c=0,b=0,k=null,f=null,g="",e="",h="";d()}
function tabs(){for(var a="",d=0;d<level;d++)a+="\t";return a}
function cleanTag(a){var d="";a=a.replace(/\n/g," ");a=a.replace(/[\s]{2,}/g," ");a=a.split(" ");for(var c=0;c<a.length;c++)if(-1==a[c].indexOf("="))d+=a[c].toLowerCase()+" ";else{var b=a[c].indexOf("="),b=[a[c].substr(0,b),a[c].substr(b+1)],d=d+(b[0].toLowerCase()+"="),k=b[1].charAt(0);if("'"==k||'"'==k){for(d+=b[1];k!=String(a[c]).charAt(String(a[c]).length-1);)d+=" "+a[++c];d+=" "}else d+="'"+b[1]+"' "}return a=d.replace(/\s*$/,">")}
var ownLine="area body head hr i?frame link meta noscript style table tbody thead tfoot".split(" "),contOwnLine="li dt dt h[1-6] option script".split(" "),lineBefore=new RegExp("^<(/?"+ownLine.join("|/?")+"|"+contOwnLine.join("|")+")[ >]");lineAfter=new RegExp("^<(br|/?"+ownLine.join("|/?")+"|/"+contOwnLine.join("|/")+")[ >]");var newLevel="blockquote div dl fieldset form frameset map ol p pre select td th tr ul".split(" "),newLevel=new RegExp("^</?("+newLevel.join("|")+")[ >]");
function placeTag(a,d){var c=a.match(newLevel);if(a.match(lineBefore)||c)d=d.replace(/\s*$/,""),d+="\n";c&&"/"==a.charAt(1)&&level--;"\n"==d.charAt(d.length-1)&&(d+=tabs());c&&"/"!=a.charAt(1)&&level++;d+=a;if(a.match(lineAfter)||a.match(newLevel))d=d.replace(/ *$/,""),d+="\n";return d}
function cleanCSS(a){function d(){for(var f=c;c<a.length&&c<f+LOOP_SIZE;c++)"{"==a.charAt(c)?(level++,b+=" {\n"+tabs()):"}"==a.charAt(c)?(b=b.replace(/\s*$/,""),level--,b+="\n"+tabs()+"}\n"+tabs()):b=";"==a.charAt(c)?b+(";\n"+tabs()):"\n"==a.charAt(c)?b+("\n"+tabs()):b+a.charAt(c);c<a.length?setTimeout(d,0):(level=k,b=b.replace(/[\s\n]*$/,""),finishTabifier(b))}var c=0;"\n"==a[0]&&(a=a.substr(1));a=a.replace(/([^\/])?\n*/g,"$1");a=a.replace(/\n\s+/g,"\n");a=a.replace(/[\t ]+/g," ");a=a.replace(/\s?([;:{},+>])\s?/g,
"$1");a=a.replace(/\{(.*):(.*)\}/g,"{$1: $2}");var b=tabs(),k=level;d()}
function cleanCStyle(a){function d(){for(var l=c;c<a.length&&c<l+LOOP_SIZE;c++)if(f=a.charAt(c),h){"//"==h&&"\n"==f?h=!1:"/*"==h&&"*/"==a.substr(c,2)&&(h=!1,f="*/\n",c++);if(!h){for(;a.charAt(++c).match(/\s/););c--;f+=tabs()}b+=f}else if(e)e!=f||"\\"==a.charAt(c-1)&&"\\"!=a.charAt(c-2)||(e=!1),b+=f;else if(g&&"("==f)g++,b+=f;else if(g&&")"==f)g--,b+=f;else if("else"==a.substr(c,4))b=b.replace(/\s*$/,"")+" e";else if(a.substr(c).match(/^for\s*\(/))for(g=1,b+="for (";"("!=a.charAt(++c););else if("//"==
a.substr(c,2))h="//",b+="//",c++;else if("/*"==a.substr(c,2))h="/*",b+="\n"+tabs()+"/*",c++;else if('"'==f||"'"==f)e=e&&f==e?!1:f,b+=f;else if("{"==f){level++;for(b=b.replace(/\s*$/,"")+" {\n"+tabs();a.charAt(++c).match(/\s/););c--}else if("}"==f){b=b.replace(/\s*$/,"");level--;for(b+="\n"+tabs()+"}\n"+tabs();a.charAt(++c).match(/\s/););c--}else if(";"!=f||g)b="\n"==f?b+("\n"+tabs()):b+f;else{for(b+=";\n"+tabs();a.charAt(++c).match(/\s/););c--}c<a.length?setTimeout(d,0):(level=k,b=b.replace(/[\s\n]*$/,
""),finishTabifier(b))}var c=0;a=a.replace(/^[\s\n]*/,"");a=a.replace(/[\s\n]*$/,"");a=a.replace(/[\n\r]+/g,"\n");var b=tabs(),k=level,f="",g=!1,e=!1,h=!1;d()};
